<?php

require "res/Services/Twilio.php";
require "globals_dime.php";

// State DONECONF implementation


	header("content-type: text/xml");
	
	// Update of the value of the global constants and variables, and the session params.
	if(isset($_GET['times_ASKDONE_dime'])){
		$times_ASKDONE_dime=$_GET['times_ASKDONE_dime'];
	} 
	if(isset($_GET['times_ISCLIENT_dime'])){
		$times_ISCLIENT_dime=$_GET['times_ISCLIENT_dime'];
	} 
	if(isset($_GET['times_ASKPEOPLE_dime'])){
		$times_ASKPEOPLE_dime=$_GET['times_ASKPEOPLE_dime'];
	} 
	if(isset($_GET['times_DONECONF_dime'])){
		$times_DONECONF_dime=$_GET['times_DONECONF_dime'];
	} 
	if(isset($_GET['hour'])){
		$hour=$_GET['hour'];
	} 
	if(isset($_GET['times_ASKHOUR_dime'])){
		$times_ASKHOUR_dime=$_GET['times_ASKHOUR_dime'];
	} 
	if(isset($_GET['people'])){
		$people=$_GET['people'];
	} 
	if(isset($_GET['times_START_dime'])){
		$times_START_dime=$_GET['times_START_dime'];
	} 
	if(isset($_GET['times_dime'])){
		$times_dime=$_GET['times_dime'];
	} 
	if(isset($_GET['times_ASKMONTH_dime'])){
		$times_ASKMONTH_dime=$_GET['times_ASKMONTH_dime'];
	} 
	if(isset($_GET['month'])){
		$month=$_GET['month'];
	} 
	if(isset($_GET['day'])){
		$day=$_GET['day'];
	} 
	if(isset($_GET['times_ASKDAY_dime'])){
		$times_ASKDAY_dime=$_GET['times_ASKDAY_dime'];
	} 
	if(isset($_GET['times_CLIENTCONF_dime'])){
		$times_CLIENTCONF_dime=$_GET['times_CLIENTCONF_dime'];
	} 
	
	
	if((!isset($_REQUEST['CallStatus']))||$_REQUEST["CallStatus"]=="in-progress"|| $_REQUEST["CallStatus"]=="ringing"|| $_REQUEST["CallStatus"]=="queued"){
	
	
	
	
	if(isset($_GET['times_DONECONF_dime'])){
		$times_DONECONF_dime=$_GET['times_DONECONF_dime']+1;
		// Times signal appears when the param reached the atribute times of the state
		
		if($_GET['times_DONECONF_dime']==3){
			
			if(isset($_GET['timesurl_dime'])){
			$url=$_GET['timesurl_dime']."?laststate_dime=DONECONF";
			$times_url=null;
			if(isset($times_ASKDONE_dime)){
				$url=$url."&amp;times_ASKDONE_dime=".urlencode($times_ASKDONE_dime);
			}if(isset($times_ISCLIENT_dime)){
				$url=$url."&amp;times_ISCLIENT_dime=".urlencode($times_ISCLIENT_dime);
			}if(isset($times_ASKPEOPLE_dime)){
				$url=$url."&amp;times_ASKPEOPLE_dime=".urlencode($times_ASKPEOPLE_dime);
			}if(isset($times_DONECONF_dime)){
				$url=$url."&amp;times_DONECONF_dime=".urlencode($times_DONECONF_dime);
			}if(isset($hour)){
				$url=$url."&amp;hour=".urlencode($hour);
			}if(isset($times_ASKHOUR_dime)){
				$url=$url."&amp;times_ASKHOUR_dime=".urlencode($times_ASKHOUR_dime);
			}if(isset($people)){
				$url=$url."&amp;people=".urlencode($people);
			}if(isset($times_START_dime)){
				$url=$url."&amp;times_START_dime=".urlencode($times_START_dime);
			}if(isset($times_dime)){
				$url=$url."&amp;times_dime=".urlencode($times_dime);
			}if(isset($times_ASKMONTH_dime)){
				$url=$url."&amp;times_ASKMONTH_dime=".urlencode($times_ASKMONTH_dime);
			}if(isset($month)){
				$url=$url."&amp;month=".urlencode($month);
			}if(isset($day)){
				$url=$url."&amp;day=".urlencode($day);
			}if(isset($times_ASKDAY_dime)){
				$url=$url."&amp;times_ASKDAY_dime=".urlencode($times_ASKDAY_dime);
			}if(isset($times_CLIENTCONF_dime)){
				$url=$url."&amp;times_CLIENTCONF_dime=".urlencode($times_CLIENTCONF_dime);
			}
			echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?> ";
			echo "<Response>";
			echo "<Redirect>".$url."</Redirect>";
			echo "</Response>";
			exit();
			}			
		}
	}else{
		$times_DONECONF_dime=1;
	}
	
	
		// Declaration of the statements of the state.
		
	echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?> ";
	echo "<Response>";	
		if((intval($_REQUEST['Digits'])==1)){
				$completedurl_dime="http://shannon.gsi.dit.upm.es/roberto/END.php";
				}
		else if((intval($_REQUEST['Digits'])==0)){
				echo "<Say voice=\"woman\" language=\"es\">"."Que dato desea modificar?"."</Say>\n"; 
		echo "<Say voice=\"woman\" language=\"es\">"."Pulse 1 para el numero de comensales."."</Say>\n"; 
		echo "<Say voice=\"woman\" language=\"es\">"."Pulse 2 para el dia"."</Say>\n"; 
		echo "<Say voice=\"woman\" language=\"es\">"."Pulse 3 para el mes"."</Say>\n"; 
		echo "<Say voice=\"woman\" language=\"es\">"."Pulse 4 para la hora"."</Say>\n"; 
		if(isset($completedurl_dime)){
					$url_dime=$completedurl_dime."?laststate_dime=DONECONF";
					if(isset($times_ASKDONE_dime)){
						$url_dime=$url_dime."&amp;times_ASKDONE_dime=".urlencode($times_ASKDONE_dime);
					}if(isset($times_ISCLIENT_dime)){
						$url_dime=$url_dime."&amp;times_ISCLIENT_dime=".urlencode($times_ISCLIENT_dime);
					}if(isset($times_ASKPEOPLE_dime)){
						$url_dime=$url_dime."&amp;times_ASKPEOPLE_dime=".urlencode($times_ASKPEOPLE_dime);
					}if(isset($times_DONECONF_dime)){
						$url_dime=$url_dime."&amp;times_DONECONF_dime=".urlencode($times_DONECONF_dime);
					}if(isset($hour)){
						$url_dime=$url_dime."&amp;hour=".urlencode($hour);
					}if(isset($times_ASKHOUR_dime)){
						$url_dime=$url_dime."&amp;times_ASKHOUR_dime=".urlencode($times_ASKHOUR_dime);
					}if(isset($people)){
						$url_dime=$url_dime."&amp;people=".urlencode($people);
					}if(isset($times_START_dime)){
						$url_dime=$url_dime."&amp;times_START_dime=".urlencode($times_START_dime);
					}if(isset($times_dime)){
						$url_dime=$url_dime."&amp;times_dime=".urlencode($times_dime);
					}if(isset($times_ASKMONTH_dime)){
						$url_dime=$url_dime."&amp;times_ASKMONTH_dime=".urlencode($times_ASKMONTH_dime);
					}if(isset($month)){
						$url_dime=$url_dime."&amp;month=".urlencode($month);
					}if(isset($day)){
						$url_dime=$url_dime."&amp;day=".urlencode($day);
					}if(isset($times_ASKDAY_dime)){
						$url_dime=$url_dime."&amp;times_ASKDAY_dime=".urlencode($times_ASKDAY_dime);
					}if(isset($times_CLIENTCONF_dime)){
						$url_dime=$url_dime."&amp;times_CLIENTCONF_dime=".urlencode($times_CLIENTCONF_dime);
					}
					echo "<Gather action=\"".$url_dime."\"  numDigits=\"1\" ></Gather>";
					echo "</Response>";
					exit();
				}else{
					$getdigits_dime=TRUE;
				}
		$completedurl_dime="http://shannon.gsi.dit.upm.es/roberto/MODIFICATION.php";
				}
		$timesurl_dime="http://shannon.gsi.dit.upm.es/roberto/TOOATTEMPTS.php";
		$errorurl_dime="http://shannon.gsi.dit.upm.es/roberto/HANGUPERROR.php";
	
		if($getdigits_dime==TRUE){
			if(isset($completedurl_dime)){
				$url_dime=$completedurl_dime."?laststate_dime=DONECONF";
				if(isset($times_ASKDONE_dime)){
					$url_dime=$url_dime."&amp;times_ASKDONE_dime=".urlencode($times_ASKDONE_dime);
				}if(isset($times_ISCLIENT_dime)){
					$url_dime=$url_dime."&amp;times_ISCLIENT_dime=".urlencode($times_ISCLIENT_dime);
				}if(isset($times_ASKPEOPLE_dime)){
					$url_dime=$url_dime."&amp;times_ASKPEOPLE_dime=".urlencode($times_ASKPEOPLE_dime);
				}if(isset($times_DONECONF_dime)){
					$url_dime=$url_dime."&amp;times_DONECONF_dime=".urlencode($times_DONECONF_dime);
				}if(isset($hour)){
					$url_dime=$url_dime."&amp;hour=".urlencode($hour);
				}if(isset($times_ASKHOUR_dime)){
					$url_dime=$url_dime."&amp;times_ASKHOUR_dime=".urlencode($times_ASKHOUR_dime);
				}if(isset($people)){
					$url_dime=$url_dime."&amp;people=".urlencode($people);
				}if(isset($times_START_dime)){
					$url_dime=$url_dime."&amp;times_START_dime=".urlencode($times_START_dime);
				}if(isset($times_dime)){
					$url_dime=$url_dime."&amp;times_dime=".urlencode($times_dime);
				}if(isset($times_ASKMONTH_dime)){
					$url_dime=$url_dime."&amp;times_ASKMONTH_dime=".urlencode($times_ASKMONTH_dime);
				}if(isset($month)){
					$url_dime=$url_dime."&amp;month=".urlencode($month);
				}if(isset($day)){
					$url_dime=$url_dime."&amp;day=".urlencode($day);
				}if(isset($times_ASKDAY_dime)){
					$url_dime=$url_dime."&amp;times_ASKDAY_dime=".urlencode($times_ASKDAY_dime);
				}if(isset($times_CLIENTCONF_dime)){
					$url_dime=$url_dime."&amp;times_CLIENTCONF_dime=".urlencode($times_CLIENTCONF_dime);
				}
				echo "<Gather action=\"".$url_dime."\"  numDigits=\"1\" ></Gather>";
				echo "</Response>";
				exit();
			}else{
				$getdigits_dime=TRUE;
			}
		}
		$url=$completedurl_dime."?"."laststate_dime=DONECONF";
		if(isset($times_ASKDONE_dime)){
			$url=$url."&amp;times_ASKDONE_dime=".urlencode($times_ASKDONE_dime);
		}if(isset($times_ISCLIENT_dime)){
			$url=$url."&amp;times_ISCLIENT_dime=".urlencode($times_ISCLIENT_dime);
		}if(isset($times_ASKPEOPLE_dime)){
			$url=$url."&amp;times_ASKPEOPLE_dime=".urlencode($times_ASKPEOPLE_dime);
		}if(isset($times_DONECONF_dime)){
			$url=$url."&amp;times_DONECONF_dime=".urlencode($times_DONECONF_dime);
		}if(isset($hour)){
			$url=$url."&amp;hour=".urlencode($hour);
		}if(isset($times_ASKHOUR_dime)){
			$url=$url."&amp;times_ASKHOUR_dime=".urlencode($times_ASKHOUR_dime);
		}if(isset($people)){
			$url=$url."&amp;people=".urlencode($people);
		}if(isset($times_START_dime)){
			$url=$url."&amp;times_START_dime=".urlencode($times_START_dime);
		}if(isset($times_dime)){
			$url=$url."&amp;times_dime=".urlencode($times_dime);
		}if(isset($times_ASKMONTH_dime)){
			$url=$url."&amp;times_ASKMONTH_dime=".urlencode($times_ASKMONTH_dime);
		}if(isset($month)){
			$url=$url."&amp;month=".urlencode($month);
		}if(isset($day)){
			$url=$url."&amp;day=".urlencode($day);
		}if(isset($times_ASKDAY_dime)){
			$url=$url."&amp;times_ASKDAY_dime=".urlencode($times_ASKDAY_dime);
		}if(isset($times_CLIENTCONF_dime)){
			$url=$url."&amp;times_CLIENTCONF_dime=".urlencode($times_CLIENTCONF_dime);
		}
		if(isset($hangupurl_dime)){
			$url=$url."&amp;hangupurl_dime=".urlencode($hangupurl_dime);
		}
		if(isset($errorurl_dime)){
			$url=$url."&amp;errorurl_dime=".urlencode($errorurl_dime);
		}
		if(isset($timesurl_dime)){
			$url=$url."&amp;timesurl_dime=".urlencode($timesurl_dime);
		}
		
		echo "<Redirect>".$url."</Redirect>";
	
		echo "</Response>";
	}
	

?>