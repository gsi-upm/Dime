<?php

require "res/Services/Twilio.php";
require "globals_dime.php";

// State end implementation


	header("content-type: text/xml");
	
	// Update of the value of the global constants and variables, and the session params.
	$company=$_GET['company']; 
	
	
	if((!isset($_REQUEST['CallStatus'])||$_REQUEST["CallStatus"]=="in-progress"|| $_REQUEST["CallStatus"]=="ringing"|| $_REQUEST["CallStatus"]=="queued"){
		
	
	
		// Declaration of the statements of the state.
		echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?> ";
		echo "<Response>";
		define("GREETING","Hello");
		echo "<Say voice=\"man\" language=\"en\">"."Thanks for calling to".$company.GREETING."</Say>\n"; 
		echo "<Play>"."http://myfile.com"."</Play>\n"; 
		if(isset($_GET['completedurl_dime'])){
			$_REQUEST['Get']="Digits";
			echo "<Gather action=\"\" numDigits=\"5\" > <Say>". "question?"."</Say> </Gather>";
			}
		if(isset($_GET['completedurl_dime'])){
					$_REQUEST['hola']="TranscriptionText";
					echo "<Record transcribe=\"true\" transcribeCallback=\"".$_GET['completedurl_dime']."\" /> \n";
					}
		echo "<Dial callerId=\""."+1 754-333-6784"."\">\n <Number>"."+34656422095"."</Number> \n </Dial> \n";
		//  HTTP GET with cURL to activate the call.
			if(!isset($_REQUEST['CallStatus'])){
					$curl_handle=curl_init();
					curl_setopt($curl_handle,CURLOPT_URL, "http://shannon.gsi.dit.upm.es/roberto/call_dime.php?number_dime=".urlencode("roberto")."&next_dime="."end"."&"."company=".urlencode($company).);
					curl_setopt($curl_handle,CURLOPT_CONNECTTIMEOUT,20);
					curl_setopt($curl_handle, CURLOPT_RETURNTRANSFER, TRUE);
					curl_exec($curl_handle);
					curl_close($curl_handle);
			}
		$hola=$_REQUEST['From']."";
		$b=($callStatus=="DISCONNECTED");
		$d=1;
		if((($callStatus=="ANSWERING"| $callStatus=="ANSWERED"))){
				$completedurl_dime=http://shannon.gsi.dit.upm.es/roberto/start.php
		$errorurl_dime=http://shannon.gsi.dit.upm.es/roberto/start.php
		$hangupurl_dime=http://shannon.gsi.dit.upm.es/roberto/start.php
		$timesurl_dime=http://shannon.gsi.dit.upm.es/roberto/start.php
		$timeouturl_dime=http://shannon.gsi.dit.upm.es/roberto/start.php
				}
		else if((($callStatus=="FAILED"))){
				echo "<Say voice=\"man\" language=\"en\">".$lastState."</Say>\n"; 
				}
		else {
				echo "<Say voice=\"man\" language=\"en\">".GREETING."</Say>\n"; 
				}
		$d="hola";
		echo "<Sms from=\""."+1 754-333-6784"."\" "." to=\"+656240934"."\">"."what the fuck"."</Sms>";
		mail("totemteleko@gmail.com", "Dime mola","CONTENT", "From: <"."dime@gsi.com"."> \r\n"); 
		echo "<Hangup /> \n"; 
		echo "<Reject /> \n"; 
		echo "<Say voice=\"man\" language=\"en\">"."FUCK"."</Say>\n"; 
	
		$url=$completedurl_dime."?"."company=".urlencode($company)."&laststate_dime=end";
		if(isset($hangupurl_dime){
			$url=$url."&hangupurl_dime=".urlencode($hangupurl_dime);
		}
		if(isset($errorurl_dime){
			$url=$url."&errorurl_dime=".urlencode($errorurl_dime);
		}
		if(isset($timesurl_dime){
			$url=$url_dime."&timesurl_dime=".urlencode($timesurl_dime);
		}
		
		echo "<Redirect>".$url."</Redirect>";
	
		echo "</Response>";
	}
	


	
?>