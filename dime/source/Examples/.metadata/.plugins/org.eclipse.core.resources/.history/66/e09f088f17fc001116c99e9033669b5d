<?php

require "res/Services/Twilio.php";
require "globals.php";

// State end implementation


	header("content-type: text/xml");

	
	// Update of the value of the global constants and variables, and the session params.
	$company=$_GET['company']; 
	
	
	if($_REQUEST["CallStatus"]=="in-progress"|| $_REQUEST["CallStatus"]=="ringing"|| $_REQUEST["CallStatus"]=="queued"){
		
	
		// Declaration of the statements of the state.
		echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?> ";
		echo "<Response>";
		define("GREETING","Hello");
		echo "<Say voice=\"man\" language=\"en\">"."Thanks for calling to".$company.GREETING."</Say>\n" ;
		echo "<Play>"."http://myfile.com"."</Play>\n" ;
		$_REQUEST['Get']="Digits";
				echo "<Gather action=\"\" numDigits=\"5\" > <Say>". "question?"."</Say> </Gather>";
		$_REQUEST['hola']="TranscriptionText";
				echo "<Record transcribe=\"true\" transcribeCallback=\"\" /> \n";
		echo "<Dial callerId=\""."+1 754-333-6784"."\">\n <Number>"."+34656422095"."</Number> \n </Dial> \n";
		//  HTTP GET with cURL to activate the call.
			
					$curl_handle=curl_init();
					curl_setopt($curl_handle,CURLOPT_URL, http://shannon.gsi.dit.upm.es/roberto/call.php?number="."roberto");
					curl_setopt($curl_handle,CURLOPT_CONNECTTIMEOUT,2);
					curl_setopt($curl_handle, CURLOPT_RETURNTRANSFER, TRUE);
					curl_exec($curl_handle);
					curl_close($curl_handle);
		$hola=$_REQUEST['From']."";
		$b=($callStatus=="DISCONNECTED");
		$d=1;
		if((($callStatus=="ANSWERING"| $callStatus=="ANSWERED"))){
				}
		else if((($callStatus=="FAILED"))){
				echo "<Say voice=\"man\" language=\"en\">".$lastState."</Say>\n" ;
				}
		else {
				echo "<Say voice=\"man\" language=\"en\">".GREETING."</Say>\n" ;
				}
		$d="hola";
		;
		echo "<Sms from=\""."+1 754-333-6784"."\" "." to=\"+656240934"."\">"."what the fuck"."</Sms>";
		mail("totemteleko@gmail.com", "Dime mola","CONTENT", "From: <"."dime@gsi.com"."> \r\n") ;
		echo "<Hangup /> \n" ;
		echo "<Reject /> \n" ;
		echo "<Say voice=\"man\" language=\"en\">"."FUCK"."</Say>\n" ;
	
	
		// Update the global variables and the session params.
	
	
		echo "<Redirect>http://shannon.gsi.dit.upm.es/roberto/start.php?"."company=".urlencode($company)."?lastState=end</Redirect>";
	
		echo "</Response>";
	}
	


// Times signal appears when the param reached the atribute times of the state

if(isset($_REQUEST['times']){
$attempts=$_REQUEST['times'];
	if($attempts==3){
		echo "<Redirect>http://shannon.gsi.dit.upm.es/roberto/start.php?"."company=".urlencode($company)."</Redirect>";
	}else{
		$attempts++;
	}
}else{
	$_REQUEST['times']=1;
}
	
	
?>