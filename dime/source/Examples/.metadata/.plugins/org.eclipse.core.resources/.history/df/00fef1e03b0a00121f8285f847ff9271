<?php

require "res/Services/Twilio.php";
require "globals_dime.php";

// State end implementation


	header("content-type: text/xml");
	
	// Update of the value of the global constants and variables, and the session params.
	if(isset($_GET['times_doneconf_dime'])){
		$times_doneconf_dime=$_GET['times_doneconf_dime'];
	} 
	if(isset($_GET['times_isclient_dime'])){
		$times_isclient_dime=$_GET['times_isclient_dime'];
	} 
	if(isset($_GET['times_askmonth_dime'])){
		$times_askmonth_dime=$_GET['times_askmonth_dime'];
	} 
	if(isset($_GET['times_askhour_dime'])){
		$times_askhour_dime=$_GET['times_askhour_dime'];
	} 
	if(isset($_GET['hour'])){
		$hour=$_GET['hour'];
	} 
	if(isset($_GET['people'])){
		$people=$_GET['people'];
	} 
	if(isset($_GET['times_tooattempts_dime'])){
		$times_tooattempts_dime=$_GET['times_tooattempts_dime'];
	} 
	if(isset($_GET['times_askdone_dime'])){
		$times_askdone_dime=$_GET['times_askdone_dime'];
	} 
	if(isset($_GET['times_clientconf_dime'])){
		$times_clientconf_dime=$_GET['times_clientconf_dime'];
	} 
	if(isset($_GET['times_hanguperror_dime'])){
		$times_hanguperror_dime=$_GET['times_hanguperror_dime'];
	} 
	if(isset($_GET['times_modification_dime'])){
		$times_modification_dime=$_GET['times_modification_dime'];
	} 
	if(isset($_GET['times_dime'])){
		$times_dime=$_GET['times_dime'];
	} 
	if(isset($_GET['times_askday_dime'])){
		$times_askday_dime=$_GET['times_askday_dime'];
	} 
	if(isset($_GET['times_end_dime'])){
		$times_end_dime=$_GET['times_end_dime'];
	} 
	if(isset($_GET['month'])){
		$month=$_GET['month'];
	} 
	if(isset($_GET['times_askpeople_dime'])){
		$times_askpeople_dime=$_GET['times_askpeople_dime'];
	} 
	if(isset($_GET['day'])){
		$day=$_GET['day'];
	} 
	if(isset($_GET['times_start_dime'])){
		$times_start_dime=$_GET['times_start_dime'];
	} 
	
	
	if((!isset($_REQUEST['CallStatus']))||$_REQUEST["CallStatus"]=="in-progress"|| $_REQUEST["CallStatus"]=="ringing"|| $_REQUEST["CallStatus"]=="queued"){
	
	
	
	
	if(isset($_GET['times_end_dime'])){
		$times_end_dime=intval($_GET['times_end_dime'])+1;
		
	}else{
		$times_end_dime=1;
		
	}
	
	
		// Declaration of the statements of the state.
		
	echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?> ";
	echo "<Response>";	
		echo "<Say voice=\"man\" language=\"en\">"."De acuerdo. Gracias por utilizar nuestro servicio de restaurantes Telcodev. Un saludo."."</Say>\n"; 
		if(($_REQUEST['From']==userNumber)){
				// Email implementation
				
				mail(userEmail, "Reservation","Usted ha solicitado una reserva en nuestro restaurante el dia ".$day."de".$month."de".year."a las ".$hour." para ".$people." personas", "From: <"."restaurant@dime.com"."> \r\n"); 
		// Send implementation for HTTP GET with cURL.
					
							$curl_handle=curl_init();
							curl_setopt($curl_handle,CURLOPT_URL,"http://host.com/saveReservation.php"."?"."caller=".userNumber."&"."day=".$day."&"."hour=".$hour."&"."month=".$month."&"."people=".$people."&"."year=".year);
							curl_setopt($curl_handle,CURLOPT_CONNECTTIMEOUT,2);
							curl_setopt($curl_handle, CURLOPT_RETURNTRANSFER, TRUE);
							curl_exec($curl_handle);
							curl_close($curl_handle);
				}
		else {
				// Send implementation for HTTP GET with cURL.
					
							$curl_handle=curl_init();
							curl_setopt($curl_handle,CURLOPT_URL,"http://host.com/saveReservation.php"."?"."caller=".$_REQUEST['From']."&"."day=".$day."&"."hour=".$hour."&"."month=".$month."&"."people=".$people."&"."year=".year);
							curl_setopt($curl_handle,CURLOPT_CONNECTTIMEOUT,2);
							curl_setopt($curl_handle, CURLOPT_RETURNTRANSFER, TRUE);
							curl_exec($curl_handle);
							curl_close($curl_handle);
				}
		echo "<Hangup /> \n"; 
	
	
		echo "</Response>";
	}
	

?>