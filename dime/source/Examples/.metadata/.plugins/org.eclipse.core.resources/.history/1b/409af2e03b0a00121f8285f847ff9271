<?php

require "res/Services/Twilio.php";
require "globals_dime.php";

// State modification implementation


	header("content-type: text/xml");
	
	// Update of the value of the global constants and variables, and the session params.
	if(isset($_GET['times_doneconf_dime'])){
		$times_doneconf_dime=$_GET['times_doneconf_dime'];
	} 
	if(isset($_GET['times_isclient_dime'])){
		$times_isclient_dime=$_GET['times_isclient_dime'];
	} 
	if(isset($_GET['times_askmonth_dime'])){
		$times_askmonth_dime=$_GET['times_askmonth_dime'];
	} 
	if(isset($_GET['times_askhour_dime'])){
		$times_askhour_dime=$_GET['times_askhour_dime'];
	} 
	if(isset($_GET['hour'])){
		$hour=$_GET['hour'];
	} 
	if(isset($_GET['people'])){
		$people=$_GET['people'];
	} 
	if(isset($_GET['times_tooattempts_dime'])){
		$times_tooattempts_dime=$_GET['times_tooattempts_dime'];
	} 
	if(isset($_GET['times_askdone_dime'])){
		$times_askdone_dime=$_GET['times_askdone_dime'];
	} 
	if(isset($_GET['times_clientconf_dime'])){
		$times_clientconf_dime=$_GET['times_clientconf_dime'];
	} 
	if(isset($_GET['times_hanguperror_dime'])){
		$times_hanguperror_dime=$_GET['times_hanguperror_dime'];
	} 
	if(isset($_GET['times_modification_dime'])){
		$times_modification_dime=$_GET['times_modification_dime'];
	} 
	if(isset($_GET['times_dime'])){
		$times_dime=$_GET['times_dime'];
	} 
	if(isset($_GET['times_askday_dime'])){
		$times_askday_dime=$_GET['times_askday_dime'];
	} 
	if(isset($_GET['times_end_dime'])){
		$times_end_dime=$_GET['times_end_dime'];
	} 
	if(isset($_GET['month'])){
		$month=$_GET['month'];
	} 
	if(isset($_GET['times_askpeople_dime'])){
		$times_askpeople_dime=$_GET['times_askpeople_dime'];
	} 
	if(isset($_GET['day'])){
		$day=$_GET['day'];
	} 
	if(isset($_GET['times_start_dime'])){
		$times_start_dime=$_GET['times_start_dime'];
	} 
	
	
	if((!isset($_REQUEST['CallStatus']))||$_REQUEST["CallStatus"]=="in-progress"|| $_REQUEST["CallStatus"]=="ringing"|| $_REQUEST["CallStatus"]=="queued"){
	
	
	
	
	if(isset($_GET['times_modification_dime'])){
		$times_modification_dime=intval($_GET['times_modification_dime'])+1;
		// Times signal appears when the param reached the atribute times of the state
		
		if($_GET['times_modification_dime']==3){
			
			if(isset($_GET['timesurl_dime'])){
			$url=$_GET['timesurl_dime']."?laststate_dime=modification";
			$times_url=NULL;
			if(isset($times_doneconf_dime)){
				$url=$url."&amp;times_doneconf_dime=".urlencode($times_doneconf_dime);
			}if(isset($times_isclient_dime)){
				$url=$url."&amp;times_isclient_dime=".urlencode($times_isclient_dime);
			}if(isset($times_askmonth_dime)){
				$url=$url."&amp;times_askmonth_dime=".urlencode($times_askmonth_dime);
			}if(isset($times_askhour_dime)){
				$url=$url."&amp;times_askhour_dime=".urlencode($times_askhour_dime);
			}if(isset($hour)){
				$url=$url."&amp;hour=".urlencode($hour);
			}if(isset($people)){
				$url=$url."&amp;people=".urlencode($people);
			}if(isset($times_tooattempts_dime)){
				$url=$url."&amp;times_tooattempts_dime=".urlencode($times_tooattempts_dime);
			}if(isset($times_askdone_dime)){
				$url=$url."&amp;times_askdone_dime=".urlencode($times_askdone_dime);
			}if(isset($times_clientconf_dime)){
				$url=$url."&amp;times_clientconf_dime=".urlencode($times_clientconf_dime);
			}if(isset($times_hanguperror_dime)){
				$url=$url."&amp;times_hanguperror_dime=".urlencode($times_hanguperror_dime);
			}if(isset($times_modification_dime)){
				$url=$url."&amp;times_modification_dime=".urlencode($times_modification_dime);
			}if(isset($times_dime)){
				$url=$url."&amp;times_dime=".urlencode($times_dime);
			}if(isset($times_askday_dime)){
				$url=$url."&amp;times_askday_dime=".urlencode($times_askday_dime);
			}if(isset($times_end_dime)){
				$url=$url."&amp;times_end_dime=".urlencode($times_end_dime);
			}if(isset($month)){
				$url=$url."&amp;month=".urlencode($month);
			}if(isset($times_askpeople_dime)){
				$url=$url."&amp;times_askpeople_dime=".urlencode($times_askpeople_dime);
			}if(isset($day)){
				$url=$url."&amp;day=".urlencode($day);
			}if(isset($times_start_dime)){
				$url=$url."&amp;times_start_dime=".urlencode($times_start_dime);
			}
			echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?> ";
			echo "<Response>";
			echo "<Redirect>".$url."</Redirect>";
			echo "</Response>";
			exit();
			}
		}			
		
	}else{
		$times_modification_dime=1;
		
	}
	
	
		// Declaration of the statements of the state.
		
	echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?> ";
	echo "<Response>";	
		if((intval($_REQUEST['Digits'])==1)){
				$completedurl_dime="http://shannon.gsi.dit.upm.es/roberto/askpeople.php";
				}
		else if((intval($_REQUEST['Digits'])==2)){
				$completedurl_dime="http://shannon.gsi.dit.upm.es/roberto/askday.php";
				}
		else if((intval($_REQUEST['Digits'])==3)){
				$completedurl_dime="http://shannon.gsi.dit.upm.es/roberto/askmonth.php";
				}
		else if((intval($_REQUEST['Digits'])==4)){
				$completedurl_dime="http://shannon.gsi.dit.upm.es/roberto/askhour.php";
				}
		else {
				echo "<Say voice=\"man\" language=\"en\">"."Disculpe, pero ha pulsado un digito equivocado."."</Say>\n"; 
		$completedurl_dime="http://shannon.gsi.dit.upm.es/roberto/doneconf.php";
				}
		$timesurl_dime="http://shannon.gsi.dit.upm.es/roberto/tooattempts.php";
		$errorurl_dime="http://shannon.gsi.dit.upm.es/roberto/hanguperror.php";
	
		$url=$completedurl_dime."?"."laststate_dime=modification";
		if(isset($times_doneconf_dime)){
			$url=$url."&amp;times_doneconf_dime=".urlencode($times_doneconf_dime);
		}if(isset($times_isclient_dime)){
			$url=$url."&amp;times_isclient_dime=".urlencode($times_isclient_dime);
		}if(isset($times_askmonth_dime)){
			$url=$url."&amp;times_askmonth_dime=".urlencode($times_askmonth_dime);
		}if(isset($times_askhour_dime)){
			$url=$url."&amp;times_askhour_dime=".urlencode($times_askhour_dime);
		}if(isset($hour)){
			$url=$url."&amp;hour=".urlencode($hour);
		}if(isset($people)){
			$url=$url."&amp;people=".urlencode($people);
		}if(isset($times_tooattempts_dime)){
			$url=$url."&amp;times_tooattempts_dime=".urlencode($times_tooattempts_dime);
		}if(isset($times_askdone_dime)){
			$url=$url."&amp;times_askdone_dime=".urlencode($times_askdone_dime);
		}if(isset($times_clientconf_dime)){
			$url=$url."&amp;times_clientconf_dime=".urlencode($times_clientconf_dime);
		}if(isset($times_hanguperror_dime)){
			$url=$url."&amp;times_hanguperror_dime=".urlencode($times_hanguperror_dime);
		}if(isset($times_modification_dime)){
			$url=$url."&amp;times_modification_dime=".urlencode($times_modification_dime);
		}if(isset($times_dime)){
			$url=$url."&amp;times_dime=".urlencode($times_dime);
		}if(isset($times_askday_dime)){
			$url=$url."&amp;times_askday_dime=".urlencode($times_askday_dime);
		}if(isset($times_end_dime)){
			$url=$url."&amp;times_end_dime=".urlencode($times_end_dime);
		}if(isset($month)){
			$url=$url."&amp;month=".urlencode($month);
		}if(isset($times_askpeople_dime)){
			$url=$url."&amp;times_askpeople_dime=".urlencode($times_askpeople_dime);
		}if(isset($day)){
			$url=$url."&amp;day=".urlencode($day);
		}if(isset($times_start_dime)){
			$url=$url."&amp;times_start_dime=".urlencode($times_start_dime);
		}
		if(isset($hangupurl_dime)){
			$url=$url."&amp;hangupurl_dime=".urlencode($hangupurl_dime);
		}
		if(isset($errorurl_dime)){
			$url=$url."&amp;errorurl_dime=".urlencode($errorurl_dime);
		}
		if(isset($timesurl_dime)){
			$url=$url."&amp;timesurl_dime=".urlencode($timesurl_dime);
		}
		
		echo "<Redirect>".$url."</Redirect>";
	
		echo "</Response>";
	}
	

?>